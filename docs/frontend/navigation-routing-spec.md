# ナビゲーション/ルーティング仕様（一覧・詳細・選択/キーボード）

目的: 一覧ビューのフィルタ/ソート/ページング状態をURLに反映し、共有可能かつ後方互換なリンクを提供する。詳細ビュー（`/company/[id]`）への遷移・復帰時に状態を維持し、選択ハイライトとキーボード移動（↑/↓）の期待動作を定義する。

関連: `tasks-frontend.md`「ナビゲーション/ルーティング」、`docs/frontend/design.md`、`docs/frontend/ui-data-mapping.md`

## スコープ
- 一覧（`/`）の検索・フィルタ・ソート・ページング・選択ハイライト。
- 詳細（`/company/[id]`）遷移時の一覧状態の持ち回り・復元。
- 共有リンクの安定性（未知キーの無視、後方互換）。

## URLクエリ I/F（一覧 `/`）
- 基本方針: 既知キーのみ解釈。未知キーは無視。無効値はデフォルトへフォールバックしエラー表示はしない。
- エンコード: 値配列はカンマ区切り（`,`）。同一キーの重複は結合し重複を除去。
- ブール: `1|true|t` を真、`0|false|f` を偽として解釈（大小無視）。
- 数値: `Number()`で解析→範囲クリップ→必要に応じ丸め。

状態→クエリの対応（キー名/型/値域/デフォルト/備考）
- `q`: 文字列。既定=`""`。空文字はクエリから削除。
- `state`: 複数候補（`ok,ng,unknown,pending`）。既定=`ok,ng,unknown,pending`。
- `score_min`: 小数（0.0〜1.0）。既定=0.0。丸め=0.05刻み。
- `score_max`: 小数（0.0〜1.0）。既定=1.0。丸め=0.05刻み。`min>max` の場合は入替。
- `source_type`: 複数候補（`official,ir,pdf,gov,wiki,news,agg,web,api,manual`）。既定=全選択。
- `method`: 複数候補（`regex,llm,failed`）。既定=全選択。
- `only_failed`: 真偽。既定=false。true のとき失敗優先抽出を有効化。
- `sort`: リスト（例: `state,-score,-updated_at`）。既定=`state,-score,-updated_at`。
  - 許可フィールド: `state|company_name|score|updated_at`。`-` で降順。
- `page`: 整数（1以上）。既定=1。
- `per_page`: 整数（10/20/50）。既定=20。許可集合外は丸め（最近傍に）または既定に戻す。
- `selected`: 文字列（会社ID）。既定=なし。可視アイテム内に存在しない場合は無視。

シリアライズ規約
- 既定値はクエリに出力しない（リンクを短く保つ）。
- 多値はカンマ区切りで安定整列（アルファベットまたはアプリ定義順）して出力。
- 数値は小数第2位までに整形（0.05刻みを担保: 例 0.83 → 0.85 に丸め）。
- `sort` は左→右が優先度。無効キーは除去。

互換性
- 既存キーの意味を変更しない。新規キー追加は任意。未知キーは常に無視。
- 値の拡張（例: `method` に新種追加）は既存値解釈を壊さない。

例
```
/?q=富士通&state=unknown,pending&score_min=0.8&source_type=official,ir&sort=state,-score,-updated_at&page=2&per_page=50&selected=acme-001
```

## 詳細 `/company/[id]` と状態維持
- URL構造: `/company/{id}?{一覧クエリ...}&selected={id}` を推奨（共有リンクで一覧条件も復元可能）。
- 一覧→詳細の遷移: `router.push`。`selected` を遷移先にも維持。
- 詳細→戻る/進む: ブラウザ履歴で一覧の前回状態を復元（クエリ/スクロール）。
- 直接流入（共有リンク）: 一覧と同等のクエリ解釈で初期状態を構築し、詳細ビューを表示。
- スクロール復元: 一覧からの遷移時にスクロール位置を保存→戻る時に復元（実装はセッションスコープに保持）。

履歴操作（push/replace）
- タイピング等の連続入力（`q`）: `replace`（履歴汚染を避ける、入力確定で1度だけ`push`はしない）。
- トグル/スライダー等のフィルタ変更: `replace`（戻るで細かな変化を積まない）。
- ページング・選択変更・ルーティング: `push`（戻る/進むの価値を担保）。

## 選択ハイライトとキーボード移動（一覧）
- ロール/フォーカス: `role="listbox"`（行は `role="option"`）、roving tabindex（選択行のみ `tabindex=0`）。
- 選択状態: `selected` 相当のスタイルを付与（視認性とコントラストを担保）。
- ↑/↓ キー: 可視アイテム内で前後に移動。境界では停止（折り返しなし）。
- Enter/Space: 選択行を詳細へ遷移（`router.push`）。
- フィルタ/ソート変更時: 選択対象が可視に残るなら維持、消える場合は先頭アイテムを自動選択。
- ページング: ページ切替時は先頭アイテムを選択（クロスページ移動は行わない）。
- マウス/タッチ: 行クリックで選択を更新（クエリ `selected` に反映）。

アクセシビリティ/ARIA
- 視覚的ハイライトに加え、`aria-selected` を更新。
- スクリーンリーダー向けに現在位置を `aria-live="polite"` で簡易アナウンス（任意）。

受入基準（ナビ/ルーティング観点）
- 共有リンクを開くと一覧条件と選択が復元され、詳細リンクはその状態を保持する。
- 戻る/進むで一覧状態（クエリ、スクロール、選択）が整合。
- 無効なクエリは静かに既定へフォールバックし、既知キーのみ反映される。

